{"title":"Tomcat 理解","date":"2019-11-01T14:10:29.000Z","date_formatted":{"ll":"2019年11月1日","L":"2019/11/01","MM-DD":"11-01"},"link":"2019/11/01/Tomcat-理解","tags":["Java"],"categories":["Java"],"updated":"2019-12-01T14:12:23.663Z","content":"<!-- build time:Sun Aug 23 2020 21:12:13 GMT+0800 (GMT+08:00) --><p>tomcat是jdk+servlet(严格地说是+jsp)实现的精简版的java ee，由于它只在jdk的基础上附加了jsp和servlet类库，所以它的应用范围主要是web应用。</p><a id=\"more\"></a><p><img src=\"https://images2017.cnblogs.com/blog/733013/201710/733013-20171023161736816-1039069357.png\" alt=\"Tomcat体系结构\" class=\"article-img\"></p><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">组织结构：</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">server</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">service</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">connector</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">connector</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">container</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">engine</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">host</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">context</span> /&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">context</span> /&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">host</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">host</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">context</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">wrapper</span> /&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">context</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">host</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">engine</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">container</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">service</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">service</span>&gt;</span></span><br><span class=\"line\">         ......</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">service</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">server</span>&gt;</span></span><br></pre></td></tr></table></div></figure><p>tomcat 安装目录结构</p><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">bin:</span> 脚本文件</span><br><span class=\"line\"><span class=\"symbol\">conf:</span> 配置文件</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">lib</span>: 类库</span></span><br><span class=\"line\"><span class=\"symbol\">logs:</span> 默认日志目录</span><br><span class=\"line\"><span class=\"symbol\">temp:</span> 临时目录</span><br><span class=\"line\"><span class=\"symbol\">webapps:</span> 存放web程序的根目录</span><br><span class=\"line\"><span class=\"symbol\">work:</span> 存放编译后生成的<span class=\"class\"><span class=\"keyword\">class</span>文件，<span class=\"title\">JSP</span>页面生成的<span class=\"title\">Servlet</span>放在<span class=\"title\">work</span>路径对应的<span class=\"title\">Web</span>应用下</span></span><br></pre></td></tr></table></div></figure><h3 id=\"问题\">问题<a href=\"2019/11/01/Tomcat-理解#问题\"></a></h3><h4 id=\"tomcat-startup-启动闪退\">tomcat startup 启动闪退<a href=\"2019/11/01/Tomcat-理解#tomcat-startup-启动闪退\"></a></h4><p>查看本地有没有其他 tomcat 线程已经启动，占用的默认端口 8005，若有，则修改 <code>%CATALINA_HOME%\\conf\\server.xml</code> 中的 Server port</p><p>查看是否设置 JAVA_HOME，CATALINA_HOME，CATALINA_BASE 环境变量。若没有，则有以下两种解决方法：</p><ol><li>设置系统环境变量或者在 <code>%CATALINA_HOME%\\bin\\startup.bat</code>，<code>%CATALINA_HOME%\\bin\\shutdown.bat</code> 文件开始位置指定这几个变量的值</li></ol><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">JAVA_HOME</span>=E:\\java\\jdk1.7.0_07</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">CATALINA_HOME</span>=E:\\test\\apache-tomcat-7.0.59</span><br><span class=\"line\"><span class=\"builtin-name\">set</span> <span class=\"attribute\">CATALINA_BASE</span>=E:\\test\\apache-tomcat-7.0.59</span><br></pre></td></tr></table></div></figure><ol start=\"2\"><li><strong>%CATALINA_HOME%\\RUNNING.txt</strong> 中建议将环境变量配置到 <code>setenv.bat</code> 中，在 <code>%CATALINA_HOME%\\bin</code> 目录下新建文件 <code>setenv.bat</code>，文件内容为</li></ol><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set <span class=\"string\">\"JAVA_HOME=E:\\java\\jdk1.7.0_07\"</span></span><br><span class=\"line\">set <span class=\"string\">\"CATALINA_HOME=E:\\test\\apache-tomcat-7.0.59\"</span></span><br><span class=\"line\">set <span class=\"string\">\"CATALINA_BASE=E:\\test\\apache-tomcat-7.0.59\"</span></span><br><span class=\"line\"><span class=\"keyword\">exit</span> <span class=\"regexp\">/b 0</span></span><br></pre></td></tr></table></div></figure><p><strong>注意：运用命令启动 [<code>%CATALINA_HOME%\\bin\\catalina.bat start</code>] /停止 [<code>%CATALINA_HOME%\\bin\\catalina.bat stop</code>] tomcat, 使用 startup.bat/shutdown.bat 会报错:</strong></p><blockquote><p>Cannot find “”<br>This file is needed to run this program.</p></blockquote><p><strong>其原因是 catalina.bat 中会执行 setenv.bat 而 startup.bat 中没有执行 setenv.bat</strong></p><h3 id=\"Tomcat-Server处理一个http请求的过程\">Tomcat Server处理一个http请求的过程<a href=\"2019/11/01/Tomcat-理解#Tomcat-Server处理一个http请求的过程\"></a></h3><p>假设来自客户的请求为：<br><a href=\"http://localhost:8080/wsota/wsota_index.jsp\" target=\"_blank\" rel=\"noopener\">http://localhost:8080/wsota/wsota_index.jsp</a><br>1) 请求被发送到本机端口8080，被在那里侦听的Coyote HTTP/1.1 Connector获得<br>2) Connector把该请求交给它所在的Service的Engine来处理 ，并等待来自Engine的回应<br>3) Engine获得请求localhost/wsota/wsota_index.jsp，匹配它所拥有的所有虚拟主机Host<br>4) Engine匹配到名为localhost的Host（即使匹配不到也把请求交给该Host处理，因为该Host被定义为该Engine的默认主机）<br>5) localhost Host获得请求/wsota/wsota_index.jsp，匹配它所拥有的所有Context<br>6) Host匹配到路径为/wsota的Context（如果匹配不到就把该请求交给路径名为””的Context去处理）<br>7) path=”/wsota”的Context获得请求/wsota_index.jsp，在它的mapping table中寻找对应的servlet<br>8) Context匹配到URL PATTERN为*.jsp的servlet，对应于JspServlet类<br>9) 构造HttpServletRequest对象和HttpServletResponse对象，作为参数调用JspServlet的doGet或doPost方法<br>10)Context把执行完了之后的HttpServletResponse对象返回给Host<br>11)Host把HttpServletResponse对象返回给Engine<br>12)Engine把HttpServletResponse对象返回给Connector<br>13)Connector把HttpServletResponse对象返回给客户browser</p><p>参考：</p><ol><li><a href=\"https://www.cnblogs.com/f-ck-need-u/p/7717488.html\" target=\"_blank\" rel=\"noopener\">Tomcat(一)：背景知识和安装tomcat</a></li><li><a href=\"https://www.cnblogs.com/f-ck-need-u/p/8120008.html#1-web-\" target=\"_blank\" rel=\"noopener\">Tomcat(二)：tomcat配置文件server.xml详解和部署简介</a></li><li><a href=\"https://www.cnblogs.com/f-ck-need-u/p/8408670.html\" target=\"_blank\" rel=\"noopener\">Tomcat(三)：tomcat处理连接的详细过程</a></li></ol><!-- rebuild by neat -->","prev":{"title":"Spring 事务","link":"2019/11/02/Spring-事务"},"next":{"title":"加密算法","link":"2019/10/25/加密算法"},"plink":"https://www.jayli.cn/2019/11/01/Tomcat-理解/","copyright":{"link":"<a href=\"https://www.jayli.cn/2019/11/01/Tomcat-理解/\" title=\"Tomcat 理解\">https://www.jayli.cn/2019/11/01/Tomcat-理解/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"2019年11月1日","author":"Jayli"}}