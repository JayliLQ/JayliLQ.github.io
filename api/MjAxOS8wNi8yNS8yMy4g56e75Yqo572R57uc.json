{"title":"移动网络","date":"2019-06-25T14:49:24.000Z","date_formatted":{"ll":"2019年6月25日","L":"2019/06/25","MM-DD":"06-25"},"link":"2019/06/25/23. 移动网络","tags":["网络协议"],"categories":["网络协议"],"updated":"2019-12-01T14:54:53.894Z","content":"<!-- build time:Sun Aug 23 2020 21:12:13 GMT+0800 (GMT+08:00) --><h2 id=\"移动网络的发展历程\">移动网络的发展历程<a href=\"2019/06/25/23. 移动网络#移动网络的发展历程\"></a></h2><h3 id=\"2G-网络\">2G 网络<a href=\"2019/06/25/23. 移动网络#2G-网络\"></a></h3><p><img src=\"https://static001.geekbang.org/resource/image/c0/e2/c065c4f15421c7fd9924c472948aa8e2.jpg\" alt=\"\" class=\"article-img\"></p><blockquote><p>MS：Mobile Station</p><p>BSS：Base Station Subsystem，基站子系统</p><p>RAN：Radio Access Network，无线接入网</p><p>BTS：Base Transceiver Station ，基站收发信台</p><p>BSC：Base Station Controller，基站控制器</p><p>CN：Core Network，核心网</p><p>NSS：Network and Switching Subsystem，网络子系统</p><p>MSC：Mobile Service Switching Center，移动业务交换中心</p><p>AUC：Authentication Center，鉴权中心</p><p>EIR：Equipment Identity Register，设备识别寄存器</p><p>VLR：Visit Location Register，访问位置寄存器，表示目前在的地方</p><p>HLR：Home Location Register，归属位置寄存器，表示号码归属地</p><p>GMSC：Gateway Mobile Switching Cente，网关移动交换中心</p><p>PSTN：Public Switched Telephone Network，公共交换电话网</p></blockquote><ul><li>手机通过无线信号连接基站</li><li>基站一面朝前接无线，一面朝后接核心网</li><li>核心网一面朝前接基站请求，一是判断你是否合法，而是判断你是不是本地号，还有没有钱，一面朝后通过网关连接电话网络</li></ul><h3 id=\"2-5G-网络\">2.5G 网络<a href=\"2019/06/25/23. 移动网络#2-5G-网络\"></a></h3><p><img src=\"https://static001.geekbang.org/resource/image/39/90/39fa17696761d28f2f04c8555041aa90.jpg\" alt=\"\" class=\"article-img\"></p><blockquote><p>PCU：Packet Control Unit，分组控制单元，用以提供分组交换通道</p><p>SGSN：Service GPRS Supported Node</p><p>GGSN：Gateway GPRS Supported Node</p></blockquote><p>在原来的电路交换基础上，加了分组交换业务，支持 Packet 的转发，从而支持 IP 网络</p><h3 id=\"3G-网络\">3G 网络<a href=\"2019/06/25/23. 移动网络#3G-网络\"></a></h3><p><img src=\"https://static001.geekbang.org/resource/image/94/18/9453ee22b697455ba3f2c4f89936b018.jpg\" alt=\"\" class=\"article-img\"></p><blockquote><p>RNC：Radio Network Controller</p></blockquote><p>无线通信技术有了改进，大大增加了无线的带宽</p><h3 id=\"4G-网络\">4G 网络<a href=\"2019/06/25/23. 移动网络#4G-网络\"></a></h3><p><img src=\"https://static001.geekbang.org/resource/image/c8/35/c83a147558c2f8c3a2c2440ca5208835.jpg\" alt=\"img\" class=\"article-img\"></p><p>HSS 用于存储用户签约信息的数据库，其实就是你这个号码归属地是哪里的，以及一些认证信息。</p><p>MME 是核心控制网元，是控制面的核心，当手机通过 eNodeB 连上的时候，MME 会根据 HSS 的信息，判断你是否合法。如果允许连上来，MME 不负责具体的数据的流量，而是 MME 会选择数据面的 SGW 和 PGW，然后告诉 eNodeB，我允许你连上来了，你连接它们吧。</p><p>于是手机直接通过 eNodeB 连接 SGW，连上核心网，SGW 相当于数据面的接待员，并通过 PGW 连到 IP 网络。PGW 就是出口网关。在出口网关，有一个组件 PCRF，称为策略和计费控制单元，用来控制上网策略和流量的计费。</p><h2 id=\"4G-网络协议解析\">4G 网络协议解析<a href=\"2019/06/25/23. 移动网络#4G-网络协议解析\"></a></h2><p><img src=\"https://static001.geekbang.org/resource/image/e4/50/e40f7cb5754e01ed82ae120d8d571f50.jpg\" alt=\"\" class=\"article-img\"></p><ul><li>控制面协议 SCTP 认证鉴权</li></ul><p><img src=\"https://static001.geekbang.org/resource/image/3b/92/3b40f3c06f95de2e261609b82163f392.jpg\" alt=\"img\" class=\"article-img\"></p><p>SCTP 也是面向连接的传输层协议，更适合移动网络。它继承了 TCP 较为完善的拥塞控制并改进 TCP 的一些不足之处</p><p>SCTP 特点：</p><ol><li>多宿主</li><li>将一个联合分成多个流</li><li>四次握手，防止 SYN 攻击</li><li>消息分帧</li><li>断开连接是三次挥手</li></ol><ul><li>控制面协议 GTP-C 建立数据通路</li></ul><p>GTP-C 协议是基于 UDP 的</p><p><img src=\"https://static001.geekbang.org/resource/image/77/cd/77eb34d092948fbf8773ef9041305fcd.jpg\" alt=\"img\" class=\"article-img\"></p><ul><li>数据面协议 GTP-U</li></ul><p><img src=\"https://static001.geekbang.org/resource/image/03/29/0397a72d0c5d76d4e3591cbe61eef729.jpg\" alt=\"img\" class=\"article-img\"></p><p>当两个隧道都打通，接在一起的时候，PGW 会给手机分配一个 IP 地址，这个 IP 地址是隧道内部的 IP 地址，可以类比为 IPsec 协议里面的 IP 地址。这个 IP 地址是归手机运营商管理的。然后，手机可以使用这个 IP 地址，连接 eNodeB，从 eNodeB 经过 S1-U 协议，通过第一段隧道到达 SGW，再从 SGW 经过 S8 协议，通过第二段隧道到达 PGW，然后通过 PGW 连接到互联网。</p><p>GTP-U 隧道封装格式：</p><p><img src=\"https://static001.geekbang.org/resource/image/84/32/84c128c408ac748f1206b9b4d4500132.jpg\" alt=\"img\" class=\"article-img\"></p><h2 id=\"手机上网流程\">手机上网流程<a href=\"2019/06/25/23. 移动网络#手机上网流程\"></a></h2><p><img src=\"https://static001.geekbang.org/resource/image/4d/d2/4d3e9282b00410a28e77f91f9375f4d2.jpg\" alt=\"img\" class=\"article-img\"></p><h2 id=\"异地上网问题\">异地上网问题<a href=\"2019/06/25/23. 移动网络#异地上网问题\"></a></h2><p><img src=\"https://static001.geekbang.org/resource/image/d0/2f/d0ef569269e3f45afbdc276fdec83f2f.jpg\" alt=\"img\" class=\"article-img\"></p><p>SGW 是你本地的运营商的设备</p><p>PGW 是你所属的运营商的设备</p><p>这样判断你是否能上网的在国内运营商的 HSS，控制你上网策略的是国内运营商的 PCRF，给手机分配的 IP 地址也是国内运营商的 PGW 负责的，给手机分配的 IP 地址也是国内运营商里统计的。运营商由于是在 PGW 里面统计的，这样你的上网流量全部通过国内运营商即可，只不过巴塞罗那运营商也要和国内运营商进行流量结算。</p><p>由于你的上网策略是由国内运营商在 PCRF 中控制的，因而你还是上不了脸书。</p><h2 id=\"小结\">小结<a href=\"2019/06/25/23. 移动网络#小结\"></a></h2><ul><li>移动网络的发展历程从 2G 到 3G，再到 4G，逐渐从打电话的功能为主，向上网的功能为主转变</li><li>请记住 4G 网络的结构，有 eNodeB、MME、SGW、PGW 等，分控制面协议和数据面协议，你可以对照着结构，试着说出手机上网的流程</li><li>即便你在国外的运营商下上网，也是要通过国内运营商控制的，因而也上不了脸书</li></ul><h2 id=\"思考\">思考<a href=\"2019/06/25/23. 移动网络#思考\"></a></h2><ul><li>咱们上网都有套餐，有交钱多的，有交钱少的，你知道移动网络是如何控制不同优先级的用户的上网流量的吗？</li><li>前面讲过的所有的网络都是基于物理机的，随着云计算兴起，无论是电商，还是移动网络都要部署在云中了，你知道云中网络的设计有哪些要点吗？</li></ul><!-- rebuild by neat -->","prev":{"title":"HTTPDNS","link":"2019/06/25/19. HTTPDNS"},"next":{"title":"HTTPS 协议","link":"2019/06/25/15. HTTPS 协议"},"plink":"https://www.jayli.cn/2019/06/25/23. 移动网络/","toc":[{"title":"移动网络的发展历程","id":"移动网络的发展历程","index":"1","children":[{"title":"2G 网络","id":"2G-网络","index":"1.1"},{"title":"2.5G 网络","id":"2-5G-网络","index":"1.2"},{"title":"3G 网络","id":"3G-网络","index":"1.3"},{"title":"4G 网络","id":"4G-网络","index":"1.4"}]},{"title":"4G 网络协议解析","id":"4G-网络协议解析","index":"2"},{"title":"手机上网流程","id":"手机上网流程","index":"3"},{"title":"异地上网问题","id":"异地上网问题","index":"4"},{"title":"小结","id":"小结","index":"5"},{"title":"思考","id":"思考","index":"6"}],"copyright":{"link":"<a href=\"https://www.jayli.cn/2019/06/25/23. 移动网络/\" title=\"移动网络\">https://www.jayli.cn/2019/06/25/23. 移动网络/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"2019年6月25日","author":"Jayli"}}