{"title":"SQL 语句","date":"2019-05-12T14:31:36.000Z","date_formatted":{"ll":"2019年5月12日","L":"2019/05/12","MM-DD":"05-12"},"link":"2019/05/12/SQL-语句","tags":["Java,数据库"],"categories":["Java"],"updated":"2019-12-01T14:33:11.060Z","content":"<!-- build time:Sun Aug 23 2020 20:59:40 GMT+0800 (GMT+08:00) --><p>SQL 语句总结。</p><a id=\"more\"></a><ul><li>关联表更新</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">MERGE</span> <span class=\"keyword\">INTO</span> 表<span class=\"number\">2</span> </span><br><span class=\"line\"><span class=\"keyword\">USING</span> 表<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"keyword\">ON</span> ( 表<span class=\"number\">2.</span>A = 表<span class=\"number\">1.</span>A )    <span class=\"comment\">-- 条件是 A 相同</span></span><br><span class=\"line\"><span class=\"keyword\">WHEN</span> <span class=\"keyword\">MATCHED</span> <span class=\"keyword\">THEN</span> <span class=\"keyword\">UPDATE</span> <span class=\"keyword\">SET</span> 表<span class=\"number\">2.</span>C = 表<span class=\"number\">1.</span>B   <span class=\"comment\">-- 匹配的时候，更新</span></span><br></pre></td></tr></table></div></figure><ul><li>条件判断</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">decode(字段,条件<span class=\"number\">1</span>,表达式<span class=\"number\">1</span>,条件<span class=\"number\">2</span>,表达式<span class=\"number\">2</span>,…表达式n)</span><br></pre></td></tr></table></div></figure><ul><li>正则查找</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">没有找到返回 <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">regexp_instr</span><span class=\"params\">(<span class=\"string\">'1010000123'</span>, <span class=\"string\">'\\D'</span>)</span></span></span><br></pre></td></tr></table></div></figure><ul><li>正则替换</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">去掉字符串前面的 <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">regexp_replace</span><span class=\"params\">(l.materialnumber,<span class=\"string\">'^[0]+'</span>,<span class=\"string\">''</span>)</span></span></span><br></pre></td></tr></table></div></figure><ul><li>将全为数字的字符串前面的 0 去掉</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT decode(regexp_instr('<span class=\"number\">1010000123</span>', '\\D'), <span class=\"number\">0</span>, regexp_replace('<span class=\"number\">1010000123</span>', '^[0]+', ''), '<span class=\"number\">1010000123</span>')</span><br><span class=\"line\">  FROM dual</span><br></pre></td></tr></table></div></figure><ul><li>查看表锁</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">--查询锁表原因</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> l.session_id <span class=\"keyword\">sid</span>,</span><br><span class=\"line\">       s.serial<span class=\"comment\">#,</span></span><br><span class=\"line\">       l.locked_mode,</span><br><span class=\"line\">       l.oracle_username,</span><br><span class=\"line\">       s.user<span class=\"comment\">#,</span></span><br><span class=\"line\">       l.os_user_name,</span><br><span class=\"line\">       s.machine,</span><br><span class=\"line\">       s.terminal,</span><br><span class=\"line\">       a.sql_text,</span><br><span class=\"line\">       a.action</span><br><span class=\"line\">  <span class=\"keyword\">FROM</span> v$sqlarea       a,</span><br><span class=\"line\">       v$<span class=\"keyword\">session</span>       s,</span><br><span class=\"line\">       v$locked_object l</span><br><span class=\"line\"> <span class=\"keyword\">WHERE</span> l.session_id = s.sid</span><br><span class=\"line\">   <span class=\"keyword\">AND</span> s.prev_sql_addr = a.address</span><br><span class=\"line\"> <span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> <span class=\"keyword\">sid</span>, s.serial<span class=\"comment\">#;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">--解决办法</span></span><br><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">system</span> <span class=\"keyword\">kill</span> <span class=\"keyword\">session</span> <span class=\"string\">'2888,44'</span>;  <span class=\"comment\">--即spid，serial</span></span><br></pre></td></tr></table></div></figure><ul><li>快速复制表结构</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> new_table_name <span class=\"keyword\">as</span> <span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> old_table_name <span class=\"keyword\">where</span> <span class=\"number\">1</span>=<span class=\"number\">2</span>;</span><br></pre></td></tr></table></div></figure><ul><li>快速插入数据</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">INSERT</span> <span class=\"keyword\">INTO</span> table_1 <span class=\"keyword\">SELECT</span> * <span class=\"keyword\">FROM</span> table_2 <span class=\"keyword\">WHERE</span> col_1 = <span class=\"string\">'xxx'</span></span><br></pre></td></tr></table></div></figure><ul><li>时间戳转换为日期</li></ul><figure class=\"highlight\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"number\">1571628926609</span> / (<span class=\"number\">1000</span> * <span class=\"number\">60</span> * <span class=\"number\">60</span> * <span class=\"number\">24</span>) +</span><br><span class=\"line\">       <span class=\"keyword\">to_date</span>(<span class=\"string\">'1970-01-01 08:00:00'</span>, <span class=\"string\">'YYYY-MM-DD HH24:MI:SS'</span>) <span class=\"keyword\">from</span> dual</span><br></pre></td></tr></table></div></figure><ul><li>sequence 序列号</li></ul><pre><code>create sequence SEQ_LOG_ID\nminvalue 1  --增长最小值\nmaxvalue 9999999999  --增长最大值,也可以设置NOMAXvalue -- 不设置最大值\nstart with 101  --从101开始计数\nincrement by 1  --自增步长为1\ncache 50  --设置缓存cache个序列，如果系统down掉了或者其它情况将会导致序列不连续，也可以设置为---NOCACHE防止跳号\ncycle;  --循环,当达到最大值时,不是从start with设置的值开始循环。而是从1开始循环\n\nCurrVal：返回 sequence的当前值 \nNextVal：增加sequence的值，然后返回 增加后sequence值\n\nDROP SEQUENCE seqTest;\n</code></pre><!-- rebuild by neat -->","prev":{"title":"Git 日常命令","link":"2019/05/15/Git-日常命令"},"next":{"title":"Linux 日常命令","link":"2019/05/11/Linux-日常命令"},"plink":"https://www.jayli.cn/2019/05/12/SQL-语句/","copyright":{"link":"<a href=\"https://www.jayli.cn/2019/05/12/SQL-语句/\" title=\"SQL 语句\">https://www.jayli.cn/2019/05/12/SQL-语句/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"2019年5月12日","author":"Jayli"}}